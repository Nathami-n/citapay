generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id          String   @id @default(uuid())
  email       String?  @unique
  phoneNumber String?  @unique // For MPESA integration
  name        String?
  password    String? // only for email/password auth
  role        UserRole @default(USER)

  // Email & phone verification
  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)

  // Account status
  isActive Boolean @default(true)

  // Security: login tracking
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?

  // Two-factor authentication
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Relations
  sessions                Session[]
  authProviders           AuthProvider[]
  merchant                Merchant?
  auditLogs               AuditLog[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([phoneNumber])
}

model AuthProvider {
  id         String           @id @default(uuid())
  type       AuthProviderType
  providerId String // e.g. Google/Facebook user ID
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now())

  @@unique([type, providerId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  replacedBy   String? // ID of the new session that replaced this one
  meta         Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([refreshToken])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// ============================================
// MERCHANT & API
// ============================================

model Merchant {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // Business info
  businessName  String
  businessEmail String?
  businessPhone String?

  // Verification & status
  status      MerchantStatus @default(PENDING)
  kycVerified Boolean        @default(false)

  // Financial
  balance        Decimal @default(0) @db.Decimal(12, 2)
  commissionRate Decimal @default(2.5) @db.Decimal(5, 2) // percentage

  // Webhook configuration
  webhookUrl    String?
  webhookSecret String?

  // Relations
  apiKeys           ApiKey[]
  transactions      Transaction[]
  webhookDeliveries WebhookDelivery[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("merchants")
}

model ApiKey {
  id        String @id @default(uuid())
  name      String // "Production Key", "Test Key"
  keyPrefix String // First 8 chars for identification (pk_live_xxx)
  keyHash   String @unique // Store hashed key, never plaintext

  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  isActive    Boolean  @default(true)
  permissions String[] // ["payments:read", "payments:write"]

  lastUsedAt DateTime?
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([keyPrefix])
  @@index([merchantId])
  @@map("api_keys")
}

// ============================================
// TRANSACTIONS & PAYMENTS
// ============================================

model Transaction {
  id          String            @id @default(uuid())
  amount      Decimal           @db.Decimal(12, 2)
  fee         Decimal?          @db.Decimal(12, 2) // Transaction fee
  netAmount   Decimal?          @db.Decimal(12, 2) // Amount after fee
  currency    String            @default("KES")
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  reference   String            @unique // Internal reference
  externalRef String? // MPESA receipt number

  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id])

  // Customer info
  customerPhone String?
  customerName  String?
  customerEmail String?

  // MPESA specific
  mpesaCheckoutId String? // For STK push tracking

  metadata Json? // Full callback payload

  completedAt DateTime?
  failedAt    DateTime?
  failReason  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@index([status])
  @@index([reference])
  @@index([externalRef])
  @@index([createdAt])
  @@map("transactions")
}

// ============================================
// WEBHOOKS
// ============================================

model WebhookDelivery {
  id         String   @id @default(uuid())
  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  event   String // "payment.completed", "payment.failed"
  payload Json

  status      WebhookStatus @default(PENDING)
  attempts    Int           @default(0)
  maxAttempts Int           @default(5)
  lastAttempt DateTime?
  nextRetry   DateTime?

  responseCode Int?
  responseBody String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId, status])
  @@index([status, nextRetry])
  @@map("webhook_deliveries")
}

// ============================================
// AUDIT & LOGGING
// ============================================

model AuditLog {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action     String // "LOGIN", "LOGOUT", "API_KEY_CREATED", "PAYMENT_INITIATED"
  resource   String? // "session", "api_key", "transaction"
  resourceId String?

  ipAddress String?
  userAgent String?
  metadata  Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// ENUMS
// ============================================

enum TransactionType {
  PAYIN
  PAYOUT
  COMMISSION
  REFUND
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum AuthProviderType {
  EMAIL
  GOOGLE
  FACEBOOK
}

enum UserRole {
  ADMIN
  MERCHANT
  USER
}

enum MerchantStatus {
  PENDING
  APPROVED
  SUSPENDED
  REJECTED
}

enum WebhookStatus {
  PENDING
  SUCCESS
  FAILED
}
