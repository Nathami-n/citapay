generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String         @id @default(uuid())
  email         String?        @unique
  name          String?
  password      String? // only for email/password auth
  role          UserRole       @default(USER)
  sessions      Session[]
  authProviders AuthProvider[]
  merchant      Merchant? // link if user is a merchant

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Merchant {
  id           String  @id @default(uuid())
  userId       String  @unique
  user         User    @relation(fields: [userId], references: [id])
  businessName String?
  balance      Decimal @default(0) @db.Decimal(10, 2)

  apiKeys      ApiKey[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("merchants")
}

model AuthProvider {
  id         String           @id @default(uuid())
  type       AuthProviderType
  providerId String // e.g. Google/Facebook user ID
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now())

  @@unique([type, providerId])
}

model Session {
  id           String   @id @default(uuid())
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  replacedBy   String? // ID of the new session that replaced this one
  meta         Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ApiKey {
  id         String    @id @default(uuid())
  key        String    @unique
  merchantId String
  merchant   Merchant  @relation(fields: [merchantId], references: [id])
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

model Transaction {
  id          String            @id @default(uuid())
  amount      Decimal           @db.Decimal(10, 2)
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  reference   String            @unique
  externalRef String? // MPESA receipt number

  merchantId String
  merchant   Merchant @relation(fields: [merchantId], references: [id])

  metadata Json? // Full MPESA callback payload

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("transactions")
}

enum TransactionType {
  PAYIN
  PAYOUT
  COMMISSION
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum AuthProviderType {
  EMAIL
  GOOGLE
  FACEBOOK
}

enum UserRole {
  ADMIN
  MERCHANT
  USER
}
